{% extends 'base.html' %}

{% load static %}

{% block extra_css %}
  <style>
    /* 1) Make sure html/body aren't blocking scrolling: */
    html, body {
      height: auto !important;
      overflow-y: auto !important;
      margin: 0;
      padding: 0;
    }

    /* 2) Let your main ".box" grow beyond the viewport and scroll if needed: */
    .box {
      max-height: 100vh;       /* never taller than the viewport */
      overflow-y: auto;        /* show a scrollbar when it's too tall */
      padding: 20px;
      box-sizing: border-box;
      margin: 0 auto;
    }
    
    /* Responsive image containers */
    .visualization-container img {
      max-width: 100%;
      height: auto;
    }
    
    /* Feature analysis section */
    .feature-analysis-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    
    .feature-item {
      flex: 1;
      min-width: 300px;
      max-width: 500px;
      text-align: center;
    }
    
    /* Responsive images */
    .feature-item img {
      max-width: 100%;
      height: auto;
    }
    
    /* Decision tree visualization */
    .tree-container {
      width: 100%;
      overflow-x: auto;
      margin: 0 auto;
    }
    
    .tree-container img {
      max-width: 100%;
      height: auto;
    }
    
    /* Dataset info box */
    .dataset-info-box {
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    
    /* Lambda slider styling */
    .lambda-control {
      max-width: 800px;
      margin: 30px auto;
      text-align: center;
      padding: 20px;
      background-color: #f0f8ff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .lambda-control h2 {
      margin-top: 0;
    }
    
    .lambda-control p {
      margin-bottom: 20px;
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .slider {
      flex: 1;
      max-width: 400px;
    }
    
    .lambda-value {
      font-weight: bold;
      width: 60px;
      text-align: center;
    }
    
    .loading {
      display: none;
      margin-top: 10px;
    }
    
    .lambda-formula {
      margin: 20px 0;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      display: inline-block;
      font-style: italic;
    }
    
    /* Media queries for smaller screens */
    @media (max-width: 768px) {
      .feature-item {
        flex: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="box">
    <div class="title-container">
        <div class="title">Project 3: Palmer Penguins Decision Tree</div>
    </div>

    <div class="main-text">
        {% if error %}
        <p class="centered-text" style="color: red;">{{ error }}</p>
        {% else %}
        
        <!-- Lambda Control Section -->
        <div class="lambda-control">
            <h2>Model Sparsity Control (λ)</h2>
            <p>Use the slider to control the importance of the model's sparsity. Higher values create simpler trees with fewer leaves.</p>
            <div class="lambda-formula">
                arg min<sub>f</sub> 1/n ∑<sub>i=1</sub><sup>n</sup> ℓ(f(x<sub>i</sub>), y<sub>i</sub>) + λΩ(f)
                <br><small>where λ controls the regularization strength (tree complexity)</small>
            </div>
            <div style="margin-top: 15px;">
                <strong>Current max_depth:</strong> <span id="max-depth-display">{{ max_depth }}</span> 
                <small>(λ inversely controls max_depth: higher λ → lower depth → simpler tree)</small>
            </div>
            <div class="slider-container">
                <span>Less sparse</span>
                <input type="range" id="lambda-slider" class="slider" min="0.001" max="1" step="0.001" value="{{ lambda_value }}">
                <span>More sparse</span>
                <div class="lambda-value">λ = <span id="lambda-display">{{ lambda_value }}</span></div>
            </div>
            <div class="loading" id="loading-indicator">
                <p>Updating model... <span id="loading-spinner">⏳</span></p>
            </div>
        </div>
        
        <section class="results-section">
            <div class="metrics">
                <h2 style="text-align: center;">Model Performance</h2>
                <div class="metrics-container" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 30px;">
                    <div class="metric-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; width: 200px;">
                        <h3>Test Accuracy</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #4CAF50;" id="accuracy-display">{{ accuracy }}%</p>
                    </div>
                    <div class="metric-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; width: 200px;">
                        <h3>Tree Complexity</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #2196F3;" id="leaves-display">{{ n_leaves }} leaves</p>
                    </div>
                </div>
            </div>

            <div class="visualization">
                <h2 style="text-align: center;">Decision Tree Visualization</h2>
                <div class="tree-container">
                    <img src="data:image/png;base64,{{ tree_plot }}" alt="Decision Tree" id="tree-image">
                </div>
            </div>

            <div class="features-section">
                <h2 style="text-align: center;">Feature Analysis</h2>
                <div class="feature-analysis-container">
                    <div class="feature-item">
                        <h3>Feature Correlation</h3>
                        <img src="data:image/png;base64,{{ corr_plot }}" alt="Correlation Heatmap">
                    </div>
                    <div class="feature-item">
                        <h3>Feature Importance</h3>
                        <img src="data:image/png;base64,{{ importance_plot }}" alt="Feature Importance" id="importance-image">
                    </div>
                </div>
            </div>
            
            <div class="dataset-info">
                <h2 style="text-align: center;">Dataset Information</h2>
                <div class="dataset-info-box">
                    <p><strong>Dataset:</strong> Palmer Penguins</p>
                    <p><strong>Target Variable:</strong> {{ target }}</p>
                    <p><strong>Features:</strong></p>
                    <ul style="columns: 2; -webkit-columns: 2; -moz-columns: 2; list-style-type: disc; margin-left: 20px;">
                        {% for feature in features %}
                        <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                    <p style="margin-top: 15px;"><strong>Description:</strong> The Palmer Penguins dataset contains size measurements for three penguin species observed on three islands in the Palmer Archipelago, Antarctica.</p>
                </div>
            </div>
        </section>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements from DOM
        const lambdaSlider = document.getElementById('lambda-slider');
        const lambdaDisplay = document.getElementById('lambda-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const leavesDisplay = document.getElementById('leaves-display');
        const treeImage = document.getElementById('tree-image');
        const importanceImage = document.getElementById('importance-image');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Variables for debouncing
        let updateTimeout;
        const DEBOUNCE_DELAY = 500; // ms
        
        // Update lambda value display when slider changes
        lambdaSlider.addEventListener('input', function() {
            lambdaDisplay.textContent = parseFloat(this.value).toFixed(3);
        });
        
        // Send request to update model when slider value changes (debounced)
        lambdaSlider.addEventListener('change', function() {
            // Clear any pending updates
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Schedule a new update
            updateTimeout = setTimeout(function() {
                updateModel(lambdaSlider.value);
            }, DEBOUNCE_DELAY);
        });
        
        // Function to update the loading animation
        let animationFrame = 0;
        const loadingChars = ['⏳', '⌛'];
        
        function animateLoading() {
            if (loadingIndicator.style.display === 'block') {
                animationFrame = (animationFrame + 1) % loadingChars.length;
                loadingSpinner.textContent = loadingChars[animationFrame];
                setTimeout(animateLoading, 500);
            }
        }
        
        // Function to update the model
        function updateModel(lambdaValue) {
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            animateLoading();
            
            // Send AJAX request
            fetch('{% url "project3:update_model" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    lambda: lambdaValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the UI with new data
                accuracyDisplay.textContent = data.accuracy + '%';
                leavesDisplay.textContent = data.n_leaves + ' leaves';
                document.getElementById('max-depth-display').textContent = data.max_depth;
                treeImage.src = 'data:image/png;base64,' + data.tree_plot;
                importanceImage.src = 'data:image/png;base64,' + data.importance_plot;
                
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error updating model:', error);
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                // Optionally show an error message
                alert('Error updating model. Please try a different lambda value or refresh the page.');
            });
        }
    });
</script>
{% endblock script %} 