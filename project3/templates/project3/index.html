{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="box box-flexible" style="padding: 20px;">

 <h1 style="text-align: center; font-size: 28px;">Project 3: Human-Centric AI - Explainability</h1>
<p style="text-align: center; font-size: 16px; color: #555; margin-top: 0;">
  Exploring Decision Trees and Logistic Regression with Model Sparsity Control.
</p>

<!-- Sparsity Control -->
  <div class="lambda-control">
    <h2>Model Sparsity Function (λ)</h2>
    <div class="lambda-formula">
      arg min<sub>f</sub> 1/n ∑<sub>i=1</sub><sup>n</sup> ℓ(f(x<sub>i</sub>), y<sub>i</sub>) + λΩ(f)
    </div>
    <input type="range" id="lambda-slider" min="0.001" max="1" step="0.001" value="{{ lambda_value }}" style="width: 60%; margin-top: 15px;">
    <div style="margin-top: 10px;">λ = <span id="lambda-display">{{ lambda_value }}</span></div>
    <div class="loading" id="loading-indicator" style="display:none;">
      <p>Updating models... <span id="loading-spinner">⏳</span></p>
    </div>
    <div style="margin-top: 10px;">
      Current max_depth: <span id="max-depth-display">{{ max_depth }}</span>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-container">
    <button class="tab-button active-tab" onclick="showTab('tree-tab', this)">Decision Tree</button>
    <button class="tab-button" onclick="showTab('logistic-tab', this)">Logistic Regression</button>
  </div>

  <!-- Fixed Height Content Container -->
  <div style="border: 1px solid #ccc; padding: 20px; min-height: 400px;">

    <!-- Decision Tree Tab -->
    <div id="tree-tab" class="tab-content" style="display:block;">
      <div class="metrics-container">
        <div class="metric-card"><h3>Accuracy</h3><p id="accuracy-display">{{ tree_accuracy }}%</p></div>
        <div class="metric-card"><h3>Tree Complexity</h3><p id="leaves-display">{{ tree_n_leaves }} leaves</p></div>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <img src="data:image/png;base64,{{ tree_plot }}" alt="Decision Tree" id="tree-image" style="max-width: 100%; height: auto;">
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <h3>Feature Importance</h3>
        <img src="data:image/png;base64,{{ importance_plot }}" alt="Feature Importance" id="importance-image" style="max-width: 100%; height: auto;">
      </div>
    </div>


    <!-- Logistic Regression Tab -->
    <div id="logistic-tab" class="tab-content" style="display:none;">
      <div class="metrics-container">
        <div class="metric-card"><h3>Accuracy</h3><p id="logistic-accuracy-display">{{ logistic_accuracy }}%</p></div>
        <div class="metric-card"><h3>Feature Complexity</h3><p id="logistic-features-display">{{ logistic_n_features }} features</p></div>
      </div>
      <div style="margin-top: 20px; text-align: center;">
        <img src="data:image/png;base64,{{ logistic_plot }}" alt="Logistic Coefficients" id="logistic-image" style="max-width: 100%; height: auto;">
      </div>
    </div>


  </div>

  
  <!-- Correlation Plot Section -->
  <div style="margin-top: 40px; text-align: center;">
    <h2>Correlation Plot</h2>
    <img src="data:image/png;base64,{{ corr_plot }}" alt="Correlation Plot" style="max-width:100%; height:auto;">
  </div>

  <!-- Dataset Information Section -->
  <div class="dataset-info-box" style="margin-top: 40px; background-color: #f9f9f9; padding: 20px; border-radius: 6px;">
    <h2>Dataset Information</h2>
    <p><strong>Dataset:</strong> Palmer Penguins</p>
    <p><strong>Target Variable:</strong> {{ target }}</p>
    <p><strong>Features:</strong></p>
    <ul style="columns:2;">
      {% for feature in features %}
        <li>{{ feature }}</li>
      {% endfor %}
    </ul>
  </div>


  

</div>
{% endblock %}

{% block script %}

<style>
    html, body {
  height: auto;
  overflow-x: hidden;
  overflow-y: auto;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
}

.box {
  max-width: 1000px;
  margin: 0 auto;
  padding: 20px;
  box-sizing: border-box;
}
.box-flexible {
  position: static;
  margin: 30px auto;
  padding: 20px;
  transform: none;
}


.lambda-control {
  max-width: 700px;
  margin: 20px auto;
  text-align: center;
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.lambda-control h2 {
  margin-top: 0;
  font-weight: bold;
  color: #333;
}

.lambda-control .lambda-formula {
  font-style: italic;
  padding: 10px;
  background-color: #fff;
  border-radius: 5px;
  display: inline-block;
  margin: 15px 0;
  font-size: 16px;
}

.lambda-control .slider-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  margin-top: 15px;
}

.lambda-control .lambda-value {
  font-weight: bold;
  padding: 5px 10px;
  background-color: #eee;
  border-radius: 5px;
}

/* Tabs Navigation */
.tabs-container {
  display: flex;
  justify-content: center;
  border-bottom: 2px solid #ccc;
  margin-top: 30px;
}

.tab-button {
  flex: 1;
  padding: 12px 0;
  border: none;
  background-color: #f1f1f1;
  color: #000;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  border-top-left-radius: 5px;
  border-top-right-radius: 5px;
  transition: background-color 0.2s ease;
}

.tab-button:hover {
  background-color: #ddd;
}

.active-tab {
  background-color: #fff;
  border: 1px solid #ccc;
  border-bottom: none;
}

/* Tab Content */
.tab-content {
  padding: 20px;
  border: 1px solid #ccc;
  background-color: #fff;
  /* ✅ Removed fixed min-height */
}

/* Metrics Cards */
.metrics-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
}

.metric-card {
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 6px;
  text-align: center;
  width: 180px;
  background-color: #fafafa;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.metric-card h3 {
  margin-top: 0;
  font-size: 16px;
  color: #555;
}

</style>


<script>
    function showTab(tabId, button) {
  document.getElementById('tree-tab').style.display = (tabId === 'tree-tab') ? 'block' : 'none';
  document.getElementById('logistic-tab').style.display = (tabId === 'logistic-tab') ? 'block' : 'none';

  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active-tab'));
  button.classList.add('active-tab');
}

document.addEventListener('DOMContentLoaded', function() {
  const lambdaSlider = document.getElementById('lambda-slider');
  const lambdaDisplay = document.getElementById('lambda-display');
  const accuracyDisplay = document.getElementById('accuracy-display');
  const leavesDisplay = document.getElementById('leaves-display');
  const treeImage = document.getElementById('tree-image');
  const importanceImage = document.getElementById('importance-image');
  const logisticAccuracyDisplay = document.getElementById('logistic-accuracy-display');
  const logisticFeaturesDisplay = document.getElementById('logistic-features-display');
  const logisticImage = document.getElementById('logistic-image');
  const maxDepthDisplay = document.getElementById('max-depth-display');
  const loadingIndicator = document.getElementById('loading-indicator');
  const loadingSpinner = document.getElementById('loading-spinner');

  let updateTimeout;
  const DEBOUNCE_DELAY = 500;

  lambdaSlider.addEventListener('input', function() {
    lambdaDisplay.textContent = parseFloat(this.value).toFixed(3);
  });

  lambdaSlider.addEventListener('change', function() {
    if (updateTimeout) clearTimeout(updateTimeout);
    updateTimeout = setTimeout(() => updateModel(lambdaSlider.value), DEBOUNCE_DELAY);
  });

  let animationFrame = 0;
  const loadingChars = ['⏳', '⌛'];

  function animateLoading() {
    if (loadingIndicator.style.display === 'block') {
      animationFrame = (animationFrame + 1) % loadingChars.length;
      loadingSpinner.textContent = loadingChars[animationFrame];
      setTimeout(animateLoading, 500);
    }
  }

  function updateModel(lambdaValue) {
    loadingIndicator.style.display = 'block';
    animateLoading();

    fetch('{% url "project3:update_model" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ lambda: lambdaValue })
    })
    .then(response => {
      if (!response.ok) throw new Error('Network response was not ok');
      return response.json();
    })
    .then(data => {
      // Decision Tree Updates
      accuracyDisplay.textContent = data.tree_accuracy + '%';
      leavesDisplay.textContent = data.tree_n_leaves + ' leaves';
      treeImage.src = 'data:image/png;base64,' + data.tree_plot;
      importanceImage.src = 'data:image/png;base64,' + data.importance_plot;
      maxDepthDisplay.textContent = data.max_depth;

      // Logistic Regression Updates
      logisticAccuracyDisplay.textContent = data.logistic_accuracy + '%';
      logisticFeaturesDisplay.textContent = data.logistic_n_features + ' features';
      logisticImage.src = 'data:image/png;base64,' + data.logistic_plot;

      loadingIndicator.style.display = 'none';
    })
    .catch(error => {
      console.error('Error updating models:', error);
      loadingIndicator.style.display = 'none';
      alert('Error updating models.');
    });
  }

  
});
</script>
{% endblock %}
