{% extends 'base.html' %}
{% load static %}

{% block title %}Project 3 - Explainable AI Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Project 3 Specific Styles */
    
    /* Lambda Control Section */
    .lambda-control {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-2xl);
        margin-bottom: var(--space-xl);
        text-align: center;
    }
    
    .lambda-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--space-lg);
    }
    
    .lambda-formula {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin: var(--space-lg) 0;
        font-style: italic;
        font-size: 1.1rem;
        color: var(--text-secondary);
        display: inline-block;
        font-family: 'Times New Roman', serif;
    }
    
    .lambda-description {
        color: var(--text-secondary);
        margin-bottom: var(--space-xl);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
    }
    
    .slider-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-lg);
        margin: var(--space-xl) 0;
        flex-wrap: wrap;
    }
    
    .slider-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .lambda-slider {
        flex: 1;
        max-width: 400px;
        height: 6px;
        background: var(--surface-elevated);
        border-radius: var(--radius-md);
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
    }
    
    .lambda-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
    }
    
    .lambda-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }
    
    .lambda-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: var(--shadow-sm);
    }
    
    .lambda-value {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-md) var(--space-lg);
        font-weight: 600;
        color: var(--accent);
        font-family: var(--font-mono);
        min-width: 100px;
    }
    
    .current-params {
        display: flex;
        justify-content: center;
        gap: var(--space-xl);
        margin-top: var(--space-lg);
        flex-wrap: wrap;
    }
    
    .param-display {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--space-md);
        text-align: center;
    }
    
    .param-label {
        color: var(--text-muted);
        font-size: 0.8rem;
        margin-bottom: var(--space-xs);
    }
    
    .param-value {
        color: var(--text-primary);
        font-weight: 600;
    }
    
    /* Loading Indicator */
    .loading-indicator {
        display: none;
        text-align: center;
        padding: var(--space-lg);
        color: var(--text-secondary);
        font-style: italic;
    }
    
    .loading-indicator.active {
        display: block;
    }
    
    .loading-spinner-custom {
        display: inline-block;
        width: 30px;
        height: 30px;
        border: 3px solid var(--surface-elevated);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: var(--space-md);
    }
    
    /* Tabs Navigation */
    .model-tabs {
        display: flex;
        gap: var(--space-xs);
        margin-bottom: var(--space-xl);
        background: var(--surface-elevated);
        border-radius: var(--radius-lg);
        padding: var(--space-xs);
        border: 1px solid var(--border);
    }
    
    .model-tab {
        flex: 1;
        padding: var(--space-lg);
        background: transparent;
        border: none;
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
    }
    
    .model-tab.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .model-tab:hover:not(.active) {
        background: var(--surface);
    }
    
    /* Content Container */
    .model-content {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
        min-height: 500px;
    }
    
    /* Tab Content */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeInUp 0.4s ease;
    }
    
    /* Metrics Display */
    .metrics-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }
    
    .metric-card {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        text-align: center;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(135deg, var(--success), var(--accent));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .metric-card:hover::before {
        transform: scaleX(1);
    }
    
    .metric-title {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: var(--space-sm);
        font-weight: 600;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--accent);
        font-family: var(--font-mono);
    }
    
    /* Visualization Container */
    .viz-container {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        text-align: center;
        margin-bottom: var(--space-xl);
    }
    
    .viz-title {
        color: var(--text-primary);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--space-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-sm);
    }
    
    .viz-container img {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
    }
    
    .viz-container img:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-md);
    }
    
    /* Correlation Section */
    .correlation-section {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
    }
    
    /* Dataset Info */
    .dataset-info {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: var(--space-xl);
        margin-bottom: var(--space-xl);
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
    }
    
    .info-item {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
    }
    
    .info-label {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-bottom: var(--space-sm);
        font-weight: 600;
    }
    
    .info-value {
        color: var(--text-primary);
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .feature-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--space-sm);
        list-style: none;
        padding: 0;
        margin-top: var(--space-lg);
    }
    
    .feature-list li {
        background: var(--surface-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: var(--space-sm) var(--space-md);
        color: var(--text-secondary);
        font-size: 0.9rem;
        transition: var(--transition-base);
    }
    
    .feature-list li:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-1px);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .slider-container {
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .lambda-slider {
            width: 100%;
            max-width: none;
        }
        
        .current-params {
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .model-tabs {
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .metrics-container {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .feature-list {
            grid-template-columns: 1fr;
        }
    }
    
    @media (max-width: 480px) {
        .metrics-container {
            grid-template-columns: 1fr;
        }
        
        .metric-value {
            font-size: 1.5rem;
        }
        
        .lambda-formula {
            font-size: 1rem;
            padding: var(--space-md);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="box">
    <div class="title-container">
        <div class="title">
            <i class="fas fa-search"></i>
            Explainable AI Dashboard
        </div>
        <div class="subtitle">
            Interactive model sparsity control with real-time explanations for Decision Trees and Logistic Regression
        </div>
    </div>

    {% if error %}
    <div class="alert alert-error">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
    </div>
    {% else %}

    <!-- Lambda Control Section -->
    <div class="lambda-control">
        <h2 class="lambda-title">
            <i class="fas fa-sliders-h"></i>
            Model Sparsity Function (λ)
        </h2>
        
        <div class="lambda-description">
            Control the complexity-performance trade-off using the regularization parameter λ. Higher values create simpler, more interpretable models with potentially lower accuracy.
        </div>
        
        <div class="lambda-formula">
            arg min<sub>f</sub> 1/n ∑<sub>i=1</sub><sup>n</sup> ℓ(f(x<sub>i</sub>), y<sub>i</sub>) + λΩ(f)
        </div>
        
        <div class="slider-container">
            <span class="slider-label">Less sparse</span>
            <input type="range" id="lambda-slider" class="lambda-slider" 
                   min="0.001" max="1" step="0.001" value="{{ lambda_value }}">
            <span class="slider-label">More sparse</span>
            <div class="lambda-value">λ = <span id="lambda-display">{{ lambda_value }}</span></div>
        </div>
        
        <div class="current-params">
            <div class="param-display">
                <div class="param-label">Decision Tree Max Depth</div>
                <div class="param-value" id="max-depth-display">{{ max_depth }}</div>
            </div>
            <div class="param-display">
                <div class="param-label">Logistic Regression C</div>
                <div class="param-value" id="c-value-display">{{ C_value }}</div>
            </div>
        </div>
        
        <div class="loading-indicator" id="loading-indicator">
            <span class="loading-spinner-custom"></span>
            Updating models with new sparsity parameter...
        </div>
    </div>

    <!-- Model Tabs -->
    <div class="model-tabs">
        <button class="model-tab active" onclick="showTab('tree-tab', this)">
            <i class="fas fa-tree"></i>
            Decision Tree
        </button>
        <button class="model-tab" onclick="showTab('logistic-tab', this)">
            <i class="fas fa-function"></i>
            Logistic Regression
        </button>
    </div>

    <!-- Model Content Container -->
    <div class="model-content">
        
        <!-- Decision Tree Tab -->
        <div id="tree-tab" class="tab-content active">
            <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-title">
                        <i class="fas fa-bullseye"></i>
                        Accuracy
                    </div>
                    <div class="metric-value" id="accuracy-display">{{ tree_accuracy }}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">
                        <i class="fas fa-sitemap"></i>
                        Tree Complexity
                    </div>
                    <div class="metric-value" id="leaves-display">{{ tree_n_leaves }} leaves</div>
                </div>
            </div>
            
            <div class="viz-container">
                <h4 class="viz-title">
                    <i class="fas fa-project-diagram"></i>
                    Decision Tree Structure
                </h4>
                <img src="data:image/png;base64,{{ tree_plot }}" alt="Decision Tree" id="tree-image">
            </div>
            
            <div class="viz-container">
                <h4 class="viz-title">
                    <i class="fas fa-chart-bar"></i>
                    Feature Importance
                </h4>
                <img src="data:image/png;base64,{{ importance_plot }}" alt="Feature Importance" id="importance-image">
            </div>
        </div>

        <!-- Logistic Regression Tab -->
        <div id="logistic-tab" class="tab-content">
            <div class="metrics-container">
                <div class="metric-card">
                    <div class="metric-title">
                        <i class="fas fa-bullseye"></i>
                        Accuracy
                    </div>
                    <div class="metric-value" id="logistic-accuracy-display">{{ logistic_accuracy }}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">
                        <i class="fas fa-layer-group"></i>
                        Feature Complexity
                    </div>
                    <div class="metric-value" id="logistic-features-display">{{ logistic_n_features }} features</div>
                </div>
            </div>
            
            <div class="viz-container">
                <h4 class="viz-title">
                    <i class="fas fa-weight"></i>
                    Model Coefficients
                </h4>
                <img src="data:image/png;base64,{{ logistic_plot }}" alt="Logistic Coefficients" id="logistic-image">
            </div>
        </div>
    </div>

    <!-- Correlation Analysis -->
    <div class="correlation-section">
        <div class="title-container">
            <h2 class="gradient-text">
                <i class="fas fa-network-wired"></i>
                Feature Correlation Analysis
            </h2>
        </div>
        <div class="viz-container">
            <img src="data:image/png;base64,{{ corr_plot }}" alt="Correlation Matrix">
        </div>
    </div>

    <!-- Dataset Information -->
    <div class="dataset-info">
        <div class="title-container">
            <h2 class="gradient-text">
                <i class="fas fa-database"></i>
                Dataset Information
            </h2>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Dataset</div>
                <div class="info-value">Palmer Penguins</div>
            </div>
            <div class="info-item">
                <div class="info-label">Target Variable</div>
                <div class="info-value">{{ target }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Number of Features</div>
                <div class="info-value">{{ features|length }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Model Type</div>
                <div class="info-value">Classification</div>
            </div>
        </div>
        
        <div>
            <h4 style="color: var(--text-primary); margin-bottom: var(--space-lg);">
                <i class="fas fa-list"></i>
                Available Features
            </h4>
            <ul class="feature-list">
                {% for feature in features %}
                <li>{{ feature }}</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="mt-xl">
            <p class="text-center" style="color: var(--text-secondary); line-height: 1.6;">
                <strong>About the Dataset:</strong> The Palmer Penguins dataset contains size measurements 
                for three penguin species observed on three islands in the Palmer Archipelago, Antarctica. 
                This dataset serves as a modern alternative to the classic Iris dataset for data exploration 
                and machine learning education.
            </p>
        </div>
    </div>

    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
    // Tab switching functionality
    function showTab(tabId, button) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active class from all tab buttons
        document.querySelectorAll('.model-tab').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab and activate button
        document.getElementById(tabId).classList.add('active');
        button.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Get DOM elements
        const lambdaSlider = document.getElementById('lambda-slider');
        const lambdaDisplay = document.getElementById('lambda-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const leavesDisplay = document.getElementById('leaves-display');
        const treeImage = document.getElementById('tree-image');
        const importanceImage = document.getElementById('importance-image');
        const logisticAccuracyDisplay = document.getElementById('logistic-accuracy-display');
        const logisticFeaturesDisplay = document.getElementById('logistic-features-display');
        const logisticImage = document.getElementById('logistic-image');
        const maxDepthDisplay = document.getElementById('max-depth-display');
        const cValueDisplay = document.getElementById('c-value-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Debouncing variables
        let updateTimeout;
        const DEBOUNCE_DELAY = 500;
        
        // Update lambda display when slider moves
        lambdaSlider.addEventListener('input', function() {
            lambdaDisplay.textContent = parseFloat(this.value).toFixed(3);
        });
        
        // Trigger model update when slider stops moving (debounced)
        lambdaSlider.addEventListener('change', function() {
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            updateTimeout = setTimeout(function() {
                updateModel(lambdaSlider.value);
            }, DEBOUNCE_DELAY);
        });
        
        // Model update function
        function updateModel(lambdaValue) {
            // Show loading indicator
            loadingIndicator.classList.add('active');
            
            // Send AJAX request
            fetch('{% url "project3:update_model" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    lambda: lambdaValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update Decision Tree metrics
                accuracyDisplay.textContent = data.tree_accuracy + '%';
                leavesDisplay.textContent = data.tree_n_leaves + ' leaves';
                treeImage.src = 'data:image/png;base64,' + data.tree_plot;
                importanceImage.src = 'data:image/png;base64,' + data.importance_plot;
                maxDepthDisplay.textContent = data.max_depth;
                
                // Update Logistic Regression metrics
                logisticAccuracyDisplay.textContent = data.logistic_accuracy + '%';
                logisticFeaturesDisplay.textContent = data.logistic_n_features + ' features';
                logisticImage.src = 'data:image/png;base64,' + data.logistic_plot;
                cValueDisplay.textContent = data.C_value;
                
                // Hide loading indicator
                loadingIndicator.classList.remove('active');
                
                // Add success feedback
                showUpdateSuccess();
            })
            .catch(error => {
                console.error('Error updating model:', error);
                loadingIndicator.classList.remove('active');
                showUpdateError('Failed to update models. Please try again.');
            });
        }
        
        // Success feedback
        function showUpdateSuccess() {
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success fade-in-down';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Models updated successfully!';
            
            document.querySelector('.lambda-control').appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.style.opacity = '0';
                successMsg.style.transform = 'translateY(-10px)';
                setTimeout(() => successMsg.remove(), 300);
            }, 2000);
        }
        
        // Error feedback
        function showUpdateError(message) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-error fade-in-down';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + message;
            
            document.querySelector('.lambda-control').appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.style.opacity = '0';
                errorMsg.style.transform = 'translateY(-10px)';
                setTimeout(() => errorMsg.remove(), 300);
            }, 4000);
        }
        
        // Smooth image transitions
        function updateImageWithTransition(img, newSrc) {
            img.style.opacity = '0.5';
            img.style.transform = 'scale(0.98)';
            
            const newImg = new Image();
            newImg.onload = function() {
                img.src = newSrc;
                img.style.opacity = '1';
                img.style.transform = 'scale(1)';
            };
            newImg.src = newSrc;
        }
        
        // Enhanced slider interaction
        lambdaSlider.addEventListener('mousedown', function() {
            this.classList.add('active');
        });
        
        document.addEventListener('mouseup', function() {
            lambdaSlider.classList.remove('active');
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case '1':
                        e.preventDefault();
                        document.querySelector('[onclick="showTab(\'tree-tab\', this)"]').click();
                        break;
                    case '2':
                        e.preventDefault();
                        document.querySelector('[onclick="showTab(\'logistic-tab\', this)"]').click();
                        break;
                }
            }
        });
        
        // Add keyboard shortcut hints
        const shortcuts = document.createElement('div');
        shortcuts.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            font-size: 0.8rem;
            color: var(--text-muted);
            z-index: 100;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        `;
        shortcuts.innerHTML = `
            <div><kbd>Ctrl+1</kbd> Decision Tree</div>
            <div><kbd>Ctrl+2</kbd> Logistic Regression</div>
        `;
        shortcuts.addEventListener('mouseenter', () => shortcuts.style.opacity = '1');
        shortcuts.addEventListener('mouseleave', () => shortcuts.style.opacity = '0.7');
        
        document.body.appendChild(shortcuts);
    });
</script>
{% endblock script %}